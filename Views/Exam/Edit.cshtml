@model OnlineSinavSistemi.Models.Exam

@{
    ViewData["Title"] = "Sınav Düzenle";
}

<div class="container mt-4">
    <h2>@ViewData["Title"]</h2>

    <div id="ajaxAlertContainer"></div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i> @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <form asp-action="Edit" method="post" id="editForm">
        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="TeacherId" />

        <div class="form-group">
            <label asp-for="Title" class="control-label font-weight-bold">Sınav Başlığı</label>
            <input asp-for="Title" class="form-control" />
            <span asp-validation-for="Title" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="CourseId" class="control-label font-weight-bold">Ders</label>
            <select asp-for="CourseId" class="form-control" asp-items="ViewBag.Dersler">
                <option value="">-- Ders Seçin --</option>
            </select>
            <span asp-validation-for="CourseId" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="DurationMinutes" class="control-label font-weight-bold">Sınav Süresi (dakika)</label>
            <input asp-for="DurationMinutes" class="form-control" type="number" min="1" max="480" />
            <span asp-validation-for="DurationMinutes" class="text-danger"></span>
            <small class="form-text text-muted">Sınav süresi dakika cinsinden (1-480 dakika).</small>
        </div>

        <input asp-for="StartDate"
               class="form-control"
               type="datetime-local"
               value="@Model.StartDate.ToString("yyyy-MM-ddTHH:mm")"
               data-val="false"
               id="StartDate"
               name="StartDate" />

        <div class="form-group mt-3">
            <button type="submit" class="btn btn-primary" id="saveBtn">
                <i class="fas fa-save"></i> Kaydet ve Listeye Dön
            </button>

            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> İptal
            </a>

            <button type="button" class="btn btn-success float-right" id="saveAndStayBtn">
                <i class="fas fa-check-circle"></i> Kaydet ve Burada Kal
            </button>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function() {
       
            // --- 2. AJAX ile Kaydetme ---
            $('#saveAndStayBtn').click(function(e) {
                e.preventDefault(); // Sayfanın normal post olmasını engelle

                var form = $('#editForm');

                // İstemci tarafı validasyon kontrolü (Boş alan vs.)
                if (!form.valid()) return;

                // Form verilerini al
                var formData = new FormData(form[0]);

                $.ajax({
                    url: '@Url.Action("Edit")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        "X-Requested-With": "XMLHttpRequest" // Controller bunu kontrol edecek
                    },
                    success: function(response) {
                        if (response.success) {
                            // Başarılı ise Alert Oluştur
                            var alertHtml = `
                                <div class="alert alert-success alert-dismissible fade show" role="alert">
                                    <i class="fas fa-check-circle me-2"></i> ${response.message}
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>`;

                            // Mesajı ekrana bas
                            $('#ajaxAlertContainer').html(alertHtml);

                            // Sayfayı YENİLEMİYORUZ (window.location.reload YOK)
                            // Böylece kullanıcı formda kalmaya devam eder.

                            // 5 saniye sonra mesajı otomatik kapat
                            setTimeout(function() { $('.alert').alert('close'); }, 5000);

                        } else {
                            // Backend validasyon hatası varsa
                            var errorMsg = response.message;
                            if(response.errors && response.errors.length > 0) {
                                errorMsg += "\n" + response.errors.join("\n");
                            }
                            alert(errorMsg);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Sunucu hatası oluştu: ' + error);
                    }
                });
            });
        });
    </script>

    <style>
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-primary {
            background-color: #667eea;
            border-color: #667eea;
        }

        .btn-success {
            background-color: #10b981;
            border-color: #10b981;
        }

        .alert {
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
}